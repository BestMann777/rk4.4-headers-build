name: Build RK4.4 Headers and xpad

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-18.04

    steps:
    # Чекаут репозитория с твоими патчами/headers
    - name: Checkout repository
      uses: actions/checkout@v3

    # Установка зависимостей
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python2 \
          build-essential \
          libncurses-dev \
          bison \
          flex \
          libssl-dev \
          bc \
          git \
          dkms \
          linux-headers-$(uname -r)

    # Сделать python2 доступным как python
    - name: Make python2 available as python
      run: |
        sudo ln -sf /usr/bin/python2 /usr/bin/python

    # Подготовка исходников ядра и headers
    - name: Prepare kernel sources
      run: |
        make mrproper
        make headers_check
        make INSTALL_HDR_PATH=./headers install

    # Клонирование xpad драйвера
    - name: Clone xpad repository
      run: |
        git clone https://github.com/paroj/xpad.git xpad-src

    # Сборка xpad драйвера
    - name: Build xpad driver
      run: |
        cd xpad-src
        make -C /usr/src/linux-headers-$(uname -r) M=$(pwd) modules

    # Проверка сборки
    - name: List built modules
      run: |
        ls -lh xpad-src/*.ko

    # Сборка и headers как артефакты
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: rk4.4-headers-and-xpad
        path: |
          ./headers
          xpad-src/*.ko
